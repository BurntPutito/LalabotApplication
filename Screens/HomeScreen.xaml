<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:LalabotApplication.Screens"
             x:Class="LalabotApplication.Screens.HomeScreen"
             Title="Dashboard">

    <RefreshView
        IsRefreshing="{Binding IsRefreshing}"
        Command="{Binding RefreshCommand}">
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="20">

                <!-- Welcome Header with Avatar -->
                <HorizontalStackLayout Spacing="15" VerticalOptions="Center" HorizontalOptions="Start">
                    <!-- Avatar -->
                    <Grid HeightRequest="60" WidthRequest="60">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NavigateToProfileCommand}"/>
                        </Grid.GestureRecognizers>
                        <Ellipse
                            Fill="White"
                            Stroke="#2D4A6E"
                            StrokeThickness="2"
                            HeightRequest="60"
                            WidthRequest="60"/>
                        <Image
                            Source="{Binding AvatarSource}"
                            Aspect="AspectFill"
                            HeightRequest="56"
                            WidthRequest="56"
                            HorizontalOptions="Center"
                            VerticalOptions="Center">
                            <Image.Clip>
                                <EllipseGeometry Center="28,28" RadiusX="28" RadiusY="28"/>
                            </Image.Clip>
                        </Image>
                    </Grid>

                    <!-- Welcome Text -->
                    <VerticalStackLayout VerticalOptions="Center" Spacing="2">
                        <Label Text="Welcome!" FontSize="18" FontFamily="OutfitLight" TextColor="#A3A3A4"/>
                        <Label Text="{Binding Username}" FontSize="26" FontFamily="OutfitRegular" FontAttributes="Bold"/>
                    </VerticalStackLayout>
                </HorizontalStackLayout>

                <!-- New Delivery Button -->
                <Grid>
                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding NewDeliveryTapCommand}" />
                    </Grid.GestureRecognizers>
                    <RoundRectangle
                        Background="AliceBlue"
                        CornerRadius="15"
                        HeightRequest="60"
                        Stroke="#2D4A6E"
                        StrokeThickness="3"/>
                    <Grid
                        ColumnDefinitions="*, *"
                        Padding="15"
                        VerticalOptions="Center"
                        HorizontalOptions="Center">
                        <Image
                            VerticalOptions="Center"
                            Grid.Column="0"
                            Scale=".5"
                            Margin="-20">
                            <Image.Source>
                                <FileImageSource File="delivery.png" />
                            </Image.Source>
                        </Image>
                        <Label
                            Grid.Column="1"
                            Text="New Delivery"
                            FontFamily="OutfitRegular"
                            FontSize="18"
                            VerticalTextAlignment="Center"
                            HorizontalTextAlignment="Start"
                            Margin="10,0,0,0" />
                    </Grid>
                </Grid>

                <!-- Analytics Card -->
                <Grid IsVisible="{Binding ShowAnalytics}" Margin="0, 0, 0, 0">
                    <RoundRectangle
                        Fill="AliceBlue"
                        CornerRadius="15"
                        Stroke="#2D4A6E"
                        StrokeThickness="2"/>

                    <VerticalStackLayout Padding="15" Spacing="10">
                        <!-- Header -->
                        <Label
                            Text="Your Stats"
                            FontFamily="OutfitRegular"
                            FontSize="18"
                            FontAttributes="Bold"
                            TextColor="#2D4A6E"/>

                        <!-- Stats Grid -->
                        <Grid ColumnDefinitions="*, *" RowDefinitions="Auto, Auto" ColumnSpacing="10" RowSpacing="10">

                            <!-- Total Sent -->
                            <Border Grid.Row="0" Grid.Column="0" 
                                    BackgroundColor="White" 
                                    Stroke="#2D4A6E" 
                                    StrokeThickness="1"
                                    Padding="10">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <VerticalStackLayout Spacing="2">
                                    <Label 
                                        Text="📤 Sent"
                                        FontFamily="OutfitLight"
                                        FontSize="12"
                                        TextColor="Gray"/>
                                    <Label 
                                        Text="{Binding TotalSent}"
                                        FontFamily="OutfitBold"
                                        FontSize="24"
                                        TextColor="#2D4A6E"/>
                                </VerticalStackLayout>
                            </Border>

                            <!-- Total Received -->
                            <Border Grid.Row="0" Grid.Column="1" 
                                    BackgroundColor="White" 
                                    Stroke="#2D4A6E" 
                                    StrokeThickness="1"
                                    Padding="10">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <VerticalStackLayout Spacing="2">
                                    <Label 
                                        Text="📥 Received"
                                        FontFamily="OutfitLight"
                                        FontSize="12"
                                        TextColor="Gray"/>
                                    <Label 
                                        Text="{Binding TotalReceived}"
                                        FontFamily="OutfitBold"
                                        FontSize="24"
                                        TextColor="#2D4A6E"/>
                                </VerticalStackLayout>
                            </Border>

                            <!-- This Week -->
                            <Border Grid.Row="1" Grid.Column="0" 
                                    BackgroundColor="White" 
                                    Stroke="#2D4A6E" 
                                    StrokeThickness="1"
                                    Padding="10">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <VerticalStackLayout Spacing="2">
                                    <Label 
                                        Text="📅 This Week"
                                        FontFamily="OutfitLight"
                                        FontSize="12"
                                        TextColor="Gray"/>
                                    <Label 
                                        Text="{Binding ThisWeekTotal}"
                                        FontFamily="OutfitBold"
                                        FontSize="24"
                                        TextColor="#2D4A6E"/>
                                </VerticalStackLayout>
                            </Border>

                            <!-- Success Rate -->
                            <Border Grid.Row="1" Grid.Column="1" 
                                    BackgroundColor="White" 
                                    Stroke="#2D4A6E" 
                                    StrokeThickness="1"
                                    Padding="10">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10"/>
                                </Border.StrokeShape>
                                <VerticalStackLayout Spacing="2">
                                    <Label 
                                        Text="✅ Success"
                                        FontFamily="OutfitLight"
                                        FontSize="12"
                                        TextColor="Gray"/>
                                    <HorizontalStackLayout Spacing="2">
                                        <Label 
                                            Text="{Binding SuccessRate}"
                                            FontFamily="OutfitBold"
                                            FontSize="24"
                                            TextColor="#4CAF50"/>
                                        <Label 
                                            Text="%"
                                            FontFamily="OutfitBold"
                                            FontSize="16"
                                            TextColor="#4CAF50"
                                            VerticalOptions="Center"/>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Border>

                        </Grid>
                    </VerticalStackLayout>
                </Grid>

                <BoxView
                    HeightRequest="1"
                    Color="Gray"/>

                <!-- Active Deliveries Section -->
                <Label
                    Text="Active Deliveries"
                    FontFamily="OutfitRegular"
                    FontSize="24"
                    FontAttributes="Bold"
                    Margin="0, -5, 0, 0"/>

                <!-- Outgoing Deliveries -->
                <Label
                    Text="Outgoing"
                    FontFamily="OutfitRegular"
                    FontSize="16"
                    TextColor="Gray"
                    Margin="0, -10"
                    IsVisible="{Binding HasOutgoingDeliveries}"/>

                <Grid IsVisible="{Binding HasOutgoingDeliveries}">
                    <VerticalStackLayout Spacing="10">
                        <CarouselView
                            x:Name="OutgoingCarousel"
                            ItemsSource="{Binding OutgoingDeliveries}"
                            HeightRequest="230"
                            PeekAreaInsets="20"
                            Loop="False"
                            CurrentItem="{Binding CurrentOutgoingDelivery}"
                            HorizontalScrollBarVisibility="Never"
                            Margin="-20, 0">
                            <CarouselView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="5">
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:HomeScreenModel}}, Path=CopyVerificationCodeCommand}"
                                                CommandParameter="{Binding .}"/>
                                        </Grid.GestureRecognizers>

                                        <RoundRectangle
                                            Fill="{Binding StatusColor}"
                                            CornerRadius="15"
                                            Stroke="#2D4A6E"
                                            StrokeThickness="2"/>

                                        <Grid Padding="15" RowDefinitions="Auto, *, Auto" RowSpacing="8">

                                            <!-- Row 0: Header with Username and Cancel Button -->
                                            <Grid Grid.Row="0" ColumnDefinitions="*, Auto">
                                                <Label
                                                    Grid.Column="0"
                                                    Text="{Binding ReceiverText}"
                                                    FontFamily="OutfitBold"
                                                    FontSize="20"
                                                    LineBreakMode="TailTruncation"
                                                    Margin="0, -5, 0, 0"/>

                                                <!-- Cancel Button (only visible for outgoing deliveries that can be cancelled) -->
                                                <Grid
                                                    Grid.Column="1"
                                                    HeightRequest="24"
                                                    WidthRequest="24"
                                                    Margin="0,-5,0,0"
                                                    VerticalOptions="Start"
                                                    HorizontalOptions="End"
                                                    IsVisible="{Binding CanBeCancelled}">
                                                    <Grid.GestureRecognizers>
                                                        <TapGestureRecognizer 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type local:HomeScreenModel}}, Path=CancelDeliveryCommand}"
                                                            CommandParameter="{Binding .}"/>
                                                    </Grid.GestureRecognizers>

                                                    <!-- Small circular background -->
                                                    <Ellipse
                                                        Fill="#FFCDD2"
                                                        HeightRequest="24"
                                                        WidthRequest="24"/>

                                                    <!-- X icon -->
                                                    <Label
                                                        Text="✕"
                                                        TextColor="#D32F2F"
                                                        FontFamily="OutfitBold"
                                                        FontSize="14"
                                                        HorizontalOptions="Center"
                                                        VerticalOptions="Center"/>
                                                </Grid>
                                            </Grid>

                                            <!-- Row 1: Delivery Info -->
                                            <Grid Grid.Row="1">

                                                <!-- CASE 1: Show Confirm Files Button (when robot at pickup, files not confirmed) -->
                                                <VerticalStackLayout Spacing="10" IsVisible="{Binding ShowConfirmFilesButton}" VerticalOptions="Center">
                                                    <Label
                                                        Text="🤖 Lalabot is waiting at pickup location"
                                                        FontFamily="OutfitRegular"
                                                        FontSize="18"
                                                        TextColor="#FF9800"
                                                        HorizontalOptions="Center"/>
                                                    <Label
                                                        Text="Please place your files in the compartment"
                                                        FontFamily="OutfitLight"
                                                        FontSize="12"
                                                        TextColor="Gray"
                                                        HorizontalOptions="Center"/>
                                                    <Button
                                                        Text="Confirm Files Placed"
                                                        BackgroundColor="#4CAF50"
                                                        TextColor="White"
                                                        FontFamily="OutfitRegular"
                                                        FontSize="16"
                                                        HeightRequest="50"
                                                        CornerRadius="10"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type local:HomeScreenModel}}, Path=ConfirmFilesPlacedCommand}"
                                                        CommandParameter="{Binding .}"/>
                                                </VerticalStackLayout>

                                                <!-- CASE 2: Show Regular Info (when files confirmed or robot not at pickup yet) -->
                                                <Grid 
                                                    ColumnDefinitions="Auto, *" 
                                                    ColumnSpacing="10"
                                                    IsVisible="{Binding ShowConfirmFilesButton, Converter={StaticResource InvertedBoolConverter}}">
                                                    <VerticalStackLayout Grid.Column="0" Spacing="3">
                                                        <Label
                                                            Text="{Binding CategoryText}"
                                                            FontFamily="OutfitLight"
                                                            FontSize="16"
                                                            TextColor="#2D4A6E"/>
                                                        <Label
                                                            Text="{Binding VerificationText}"
                                                            FontFamily="OutfitRegular"
                                                            FontSize="16"
                                                            IsVisible="{Binding ShowVerificationCode}"/>
                                                        <Label
                                                            Text="{Binding PickupText}"
                                                            FontFamily="OutfitLight"
                                                            FontSize="15"
                                                            TextColor="Gray"/>
                                                        <Label
                                                            Text="{Binding DestinationText}"
                                                            FontFamily="OutfitLight"
                                                            FontSize="15"
                                                            TextColor="Gray"/>
                                                        <Label
                                                            Text="{Binding StatusText}"
                                                            FontFamily="OutfitRegular"
                                                            FontSize="15"
                                                            TextColor="#2D4A6E"/>
                                                    </VerticalStackLayout>

                                                    <Border 
                                                        Grid.Column="1"
                                                        BackgroundColor="#FFFFFF"
                                                        Stroke="#2D4A6E"
                                                        StrokeThickness="1"
                                                        Padding="8"
                                                        VerticalOptions="Fill"
                                                        IsVisible="{Binding HasMessage}">
                                                        <Border.StrokeShape>
                                                            <RoundRectangle CornerRadius="8"/>
                                                        </Border.StrokeShape>
                                                        <ScrollView>
                                                            <Label
                                                                Text="{Binding Message}"
                                                                Margin="0, -4"
                                                                FontFamily="OutfitLight"
                                                                FontSize="13"
                                                                TextColor="#2D4A6E"
                                                                LineBreakMode="WordWrap"/>
                                                        </ScrollView>
                                                    </Border>
                                                </Grid>
                                            </Grid>

                                            <!-- Row 2: Progress Tracker (only shown after files confirmed) -->
                                            <Grid 
                                                Grid.Row="2"
                                                RowDefinitions="Auto, Auto" 
                                                RowSpacing="1"
                                                IsVisible="{Binding ShowProgressTracker}">

                                                <HorizontalStackLayout 
                                                    Grid.Row="0" 
                                                    Spacing="5" 
                                                    HorizontalOptions="Center">

                                                    <!-- Stage 0: Processing -->
                                                    <Grid HeightRequest="24" WidthRequest="24">
                                                        <Ellipse 
                                                            Fill="{Binding Stage0Color}" 
                                                            Stroke="#2D4A6E" 
                                                            StrokeThickness="2"/>
                                                        <Label 
                                                            Text="{Binding Stage0Icon}" 
                                                            HorizontalOptions="Center" 
                                                            VerticalOptions="Center"
                                                            FontSize="12"
                                                            FontAttributes="Bold"
                                                            TextColor="White"/>
                                                    </Grid>

                                                    <BoxView 
                                                        BackgroundColor="#2D4A6E" 
                                                        HeightRequest="2" 
                                                        WidthRequest="15" 
                                                        VerticalOptions="Center"/>

                                                    <!-- Stage 1: On the Way -->
                                                    <Grid HeightRequest="24" WidthRequest="24">
                                                        <Ellipse 
                                                            Fill="{Binding Stage1Color}" 
                                                            Stroke="#2D4A6E" 
                                                            StrokeThickness="2"/>
                                                        <Label 
                                                            Text="{Binding Stage1Icon}" 
                                                            HorizontalOptions="Center" 
                                                            VerticalOptions="Center"
                                                            FontSize="12"
                                                            FontAttributes="Bold"
                                                            TextColor="White"/>
                                                    </Grid>

                                                    <BoxView 
                                                        BackgroundColor="#2D4A6E" 
                                                        HeightRequest="2" 
                                                        WidthRequest="15" 
                                                        VerticalOptions="Center"/>

                                                    <!-- Stage 2: Near Destination -->
                                                    <Grid HeightRequest="24" WidthRequest="24">
                                                        <Ellipse 
                                                            Fill="{Binding Stage2Color}" 
                                                            Stroke="#2D4A6E" 
                                                            StrokeThickness="2"/>
                                                        <Label 
                                                            Text="{Binding Stage2Icon}" 
                                                            HorizontalOptions="Center" 
                                                            VerticalOptions="Center"
                                                            FontSize="12"
                                                            FontAttributes="Bold"
                                                            TextColor="White"/>
                                                    </Grid>

                                                    <BoxView 
                                                        BackgroundColor="#2D4A6E" 
                                                        HeightRequest="2" 
                                                        WidthRequest="15" 
                                                        VerticalOptions="Center"/>

                                                    <!-- Stage 3: Arrived -->
                                                    <Grid HeightRequest="24" WidthRequest="24">
                                                        <Ellipse 
                                                            Fill="{Binding Stage3Color}" 
                                                            Stroke="#2D4A6E" 
                                                            StrokeThickness="2"/>
                                                        <Label 
                                                            Text="{Binding Stage3Icon}" 
                                                            HorizontalOptions="Center" 
                                                            VerticalOptions="Center"
                                                            FontSize="12"
                                                            FontAttributes="Bold"
                                                            TextColor="White"/>
                                                    </Grid>
                                                </HorizontalStackLayout>

                                                <Label 
                                                    Grid.Row="1"
                                                    Text="{Binding ProgressText}" 
                                                    FontFamily="OutfitLight" 
                                                    FontSize="11" 
                                                    HorizontalOptions="Center"
                                                    TextColor="#2D4A6E"/>
                                            </Grid>

                                        </Grid>
                                    </Grid>
                                </DataTemplate>
                            </CarouselView.ItemTemplate>
                        </CarouselView>

                        <IndicatorView
                            IndicatorColor="LightGray"
                            SelectedIndicatorColor="#2D4A6E"
                            HorizontalOptions="Center"
                            IndicatorsShape="Circle"
                            IndicatorSize="8"
                            ItemsSource="{Binding OutgoingDeliveries}"
                            Position="{Binding Source={x:Reference OutgoingCarousel}, Path=Position}"/>
                    </VerticalStackLayout>
                </Grid>

                <!-- Incoming Deliveries -->
                <Label
                    Text="Incoming"
                    FontFamily="OutfitRegular"
                    FontSize="16"
                    TextColor="Gray"
                    Margin="0, 10, 0, 0"
                    IsVisible="{Binding HasIncomingDeliveries}"/>

                <Grid IsVisible="{Binding HasIncomingDeliveries}">
                    <VerticalStackLayout Spacing="10">
                        <CarouselView
                            x:Name="IncomingCarousel"
                            ItemsSource="{Binding IncomingDeliveries}"
                            HeightRequest="230"
                            PeekAreaInsets="20"
                            Loop="False"
                            CurrentItem="{Binding CurrentIncomingDelivery}"
                            HorizontalScrollBarVisibility="Never"
                            Margin="-20, 0">
                            <CarouselView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="5">
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:HomeScreenModel}}, Path=CopyVerificationCodeCommand}"
                                                CommandParameter="{Binding .}"/>
                                        </Grid.GestureRecognizers>

                                        <RoundRectangle
                                            Fill="{Binding StatusColor}"
                                            CornerRadius="15"
                                            Stroke="#2D4A6E"
                                            StrokeThickness="2"/>

                                        <Grid Padding="15" RowDefinitions="Auto, *, Auto" RowSpacing="8">

                                            <!-- Row 0: Username Header -->
                                            <Label
                                                Grid.Row="0"
                                                Text="{Binding SenderText}"
                                                FontFamily="OutfitBold"
                                                FontSize="20"
                                                LineBreakMode="TailTruncation"
                                                Margin="0, -5, 0, 0"/>

                                            <!-- Row 1: Delivery Info OR Verification/Receipt Confirmation -->
                                            <Grid Grid.Row="1">

                                                <!-- CASE 1: Show Verification Input (when robot arrived, waiting for code) -->
                                                <VerticalStackLayout Spacing="10" IsVisible="{Binding ShowVerificationInput}" VerticalOptions="Center">
                                                    <Label
                                                        Text="📦 Delivery has arrived!"
                                                        FontFamily="OutfitRegular"
                                                        FontSize="18"
                                                        TextColor="#4CAF50"
                                                        HorizontalOptions="Center"/>
                                                    <Label
                                                        Text="Enter the verification code to open compartment"
                                                        FontFamily="OutfitLight"
                                                        FontSize="12"
                                                        TextColor="Gray"
                                                        HorizontalOptions="Center"/>
                                                    <Button
                                                        Text="Enter Verification Code"
                                                        BackgroundColor="#2D4A6E"
                                                        TextColor="White"
                                                        FontFamily="OutfitRegular"
                                                        FontSize="16"
                                                        HeightRequest="50"
                                                        CornerRadius="10"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type local:HomeScreenModel}}, Path=EnterVerificationCodeCommand}"
                                                        CommandParameter="{Binding .}"/>
                                                </VerticalStackLayout>

                                                <!-- CASE 2: Show Confirm Receipt Button (after successful verification) -->
                                                <VerticalStackLayout Spacing="10" IsVisible="{Binding ShowConfirmReceiptButton}">
                                                    <Label
                                                        Text="📂 Compartment is open"
                                                        FontFamily="OutfitRegular"
                                                        FontSize="16"
                                                        TextColor="#4CAF50"
                                                        HorizontalOptions="Center"/>
                                                    <Label
                                                        Text="Please retrieve your files and confirm receipt"
                                                        FontFamily="OutfitLight"
                                                        FontSize="12"
                                                        TextColor="Gray"
                                                        HorizontalOptions="Center"/>
                                                    <Button
                                                        Text="Confirm Receipt"
                                                        BackgroundColor="#4CAF50"
                                                        TextColor="White"
                                                        FontFamily="OutfitRegular"
                                                        FontSize="16"
                                                        HeightRequest="50"
                                                        CornerRadius="10"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type local:HomeScreenModel}}, Path=ConfirmReceiptCommand}"
                                                        CommandParameter="{Binding .}"/>
                                                </VerticalStackLayout>

                                                <!-- CASE 3: Show Regular Info (default view) -->
                                                <Grid 
                                                    ColumnDefinitions="Auto, *" 
                                                    ColumnSpacing="10"
                                                    IsVisible="{Binding ShowRegularInfo}">
                                                    <VerticalStackLayout Grid.Column="0" Spacing="3">
                                                        <Label
                                                            Text="{Binding CategoryText}"
                                                            FontFamily="OutfitLight"
                                                            FontSize="16"
                                                            TextColor="#2D4A6E"/>
                                                        <Label
                                                            Text="{Binding VerificationText}"
                                                            FontFamily="OutfitRegular"
                                                            FontSize="16"/>
                                                        <Label
                                                            Text="{Binding PickupText}"
                                                            FontFamily="OutfitLight"
                                                            FontSize="15"
                                                            TextColor="Gray"/>
                                                        <Label
                                                            Text="{Binding DestinationText}"
                                                            FontFamily="OutfitLight"
                                                            FontSize="15"
                                                            TextColor="Gray"/>
                                                        <Label
                                                            Text="{Binding StatusText}"
                                                            FontFamily="OutfitRegular"
                                                            FontSize="15"
                                                            TextColor="#2D4A6E"/>
                                                    </VerticalStackLayout>

                                                    <Border 
                                                        Grid.Column="1"
                                                        BackgroundColor="#FFFFFF"
                                                        Stroke="#2D4A6E"
                                                        StrokeThickness="1"
                                                        Padding="8"
                                                        VerticalOptions="Fill"
                                                        IsVisible="{Binding HasMessage}">
                                                        <Border.StrokeShape>
                                                            <RoundRectangle CornerRadius="8"/>
                                                        </Border.StrokeShape>
                                                        <ScrollView>
                                                            <Label
                                                                Text="{Binding Message}"
                                                                Margin="0, -4"
                                                                FontFamily="OutfitLight"
                                                                FontSize="13"
                                                                TextColor="#2D4A6E"
                                                                LineBreakMode="WordWrap"/>
                                                        </ScrollView>
                                                    </Border>
                                                </Grid>
                                            </Grid>

                                            <!-- Row 2: Progress Tracker -->
                                            <Grid 
                                                Grid.Row="2"
                                                RowDefinitions="Auto, Auto" 
                                                RowSpacing="1"
                                                IsVisible="{Binding ShowProgressTracker}">

                                                <HorizontalStackLayout 
                                                    Grid.Row="0" 
                                                    Spacing="5" 
                                                    HorizontalOptions="Center">

                                                    <!-- Stage 0: Processing -->
                                                    <Grid HeightRequest="24" WidthRequest="24">
                                                        <Ellipse 
                                                            Fill="{Binding Stage0Color}" 
                                                            Stroke="#2D4A6E" 
                                                            StrokeThickness="2"/>
                                                        <Label 
                                                            Text="{Binding Stage0Icon}" 
                                                            HorizontalOptions="Center" 
                                                            VerticalOptions="Center"
                                                            FontSize="12"
                                                            FontAttributes="Bold"
                                                            TextColor="White"/>
                                                    </Grid>

                                                    <BoxView 
                                                        BackgroundColor="#2D4A6E" 
                                                        HeightRequest="2" 
                                                        WidthRequest="15" 
                                                        VerticalOptions="Center"/>

                                                    <!-- Stage 1: On the Way -->
                                                    <Grid HeightRequest="24" WidthRequest="24">
                                                        <Ellipse 
                                                            Fill="{Binding Stage1Color}" 
                                                            Stroke="#2D4A6E" 
                                                            StrokeThickness="2"/>
                                                        <Label 
                                                            Text="{Binding Stage1Icon}" 
                                                            HorizontalOptions="Center" 
                                                            VerticalOptions="Center"
                                                            FontSize="12"
                                                            FontAttributes="Bold"
                                                            TextColor="White"/>
                                                    </Grid>

                                                    <BoxView 
                                                        BackgroundColor="#2D4A6E" 
                                                        HeightRequest="2" 
                                                        WidthRequest="15" 
                                                        VerticalOptions="Center"/>

                                                    <!-- Stage 2: Near Destination -->
                                                    <Grid HeightRequest="24" WidthRequest="24">
                                                        <Ellipse 
                                                            Fill="{Binding Stage2Color}" 
                                                            Stroke="#2D4A6E" 
                                                            StrokeThickness="2"/>
                                                        <Label 
                                                            Text="{Binding Stage2Icon}" 
                                                            HorizontalOptions="Center" 
                                                            VerticalOptions="Center"
                                                            FontSize="12"
                                                            FontAttributes="Bold"
                                                            TextColor="White"/>
                                                    </Grid>

                                                    <BoxView 
                                                        BackgroundColor="#2D4A6E" 
                                                        HeightRequest="2" 
                                                        WidthRequest="15" 
                                                        VerticalOptions="Center"/>

                                                    <!-- Stage 3: Arrived -->
                                                    <Grid HeightRequest="24" WidthRequest="24">
                                                        <Ellipse 
                                                            Fill="{Binding Stage3Color}" 
                                                            Stroke="#2D4A6E" 
                                                            StrokeThickness="2"/>
                                                        <Label 
                                                            Text="{Binding Stage3Icon}" 
                                                            HorizontalOptions="Center" 
                                                            VerticalOptions="Center"
                                                            FontSize="12"
                                                            FontAttributes="Bold"
                                                            TextColor="White"/>
                                                    </Grid>
                                                </HorizontalStackLayout>

                                                <Label 
                                                    Grid.Row="1" 
                                                    Text="{Binding ProgressText}" 
                                                    FontFamily="OutfitLight" 
                                                    FontSize="11" 
                                                    HorizontalOptions="Center"
                                                    TextColor="#2D4A6E"/>
                                            </Grid>

                                        </Grid>
                                    </Grid>
                                </DataTemplate>
                            </CarouselView.ItemTemplate>
                        </CarouselView>

                        <IndicatorView
                            IndicatorColor="LightGray"
                            SelectedIndicatorColor="#2D4A6E"
                            HorizontalOptions="Center"
                            IndicatorsShape="Circle"
                            IndicatorSize="8"
                            ItemsSource="{Binding IncomingDeliveries}"
                            Position="{Binding Source={x:Reference IncomingCarousel}, Path=Position}"/>
                    </VerticalStackLayout>
                </Grid>

                <!-- Empty State -->
                <VerticalStackLayout 
                    IsVisible="{Binding HasNoDeliveries}"
                    Spacing="10"
                    VerticalOptions="Center"
                    Margin="0, 40, 0, 0">
                    <Label
                        Text="📦"
                        FontSize="60"
                        HorizontalOptions="Center"/>
                    <Label
                        Text="No active deliveries"
                        FontFamily="OutfitRegular"
                        FontSize="18"
                        TextColor="Gray"
                        HorizontalOptions="Center"/>
                    <Label
                        Text="Create a delivery to get started!"
                        FontFamily="OutfitLight"
                        FontSize="14"
                        TextColor="Gray"
                        HorizontalOptions="Center"/>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>