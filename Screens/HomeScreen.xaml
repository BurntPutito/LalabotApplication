<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
                 xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                 xmlns:local="clr-namespace:LalabotApplication.Screens"
                 x:Class="LalabotApplication.Screens.HomeScreen"
                 Title="Home">

    <RefreshView
            IsRefreshing="{Binding IsRefreshing}"
            Command="{Binding RefreshCommand}">
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="20">

                <!-- Welcome Header -->
                <Label>
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="Welcome! " FontSize="30" FontFamily="OutfitRegular"/>
                            <Span Text="{Binding Username}" FontSize="30" FontFamily="OutfitRegular" FontAttributes="Bold"/>
                        </FormattedString>
                    </Label.FormattedText>
                </Label>

                <!-- New Delivery Button -->
                <Grid>
                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding NewDeliveryTapCommand}" />
                    </Grid.GestureRecognizers>
                    <RoundRectangle
                        Background="AliceBlue"
                        CornerRadius="15"
                        HeightRequest="60"
                        Stroke="#2D4A6E"
                        StrokeThickness="3"/>
                    <Grid
                        ColumnDefinitions="*, *"
                        Padding="15"
                        VerticalOptions="Center"
                        HorizontalOptions="Center">
                        <Image
                            VerticalOptions="Center"
                            Grid.Column="0"
                            Scale=".5"
                            Margin="-20">
                            <Image.Source>
                                <FileImageSource File="delivery.png" />
                            </Image.Source>
                        </Image>
                        <Label
                            Grid.Column="1"
                            Text="New Delivery"
                            FontFamily="OutfitRegular"
                            FontSize="18"
                            VerticalTextAlignment="Center"
                            HorizontalTextAlignment="Start"
                            Margin="10,0,0,0" />
                    </Grid>
                </Grid>

                <!-- Active Deliveries Section -->
                <Label
                    Text="Active Deliveries"
                    FontFamily="OutfitRegular"
                    FontSize="22"
                    FontAttributes="Bold"
                    Margin="0, 10, 0, 0"/>

                <!-- Outgoing Deliveries -->
                <Label
                    Text="Outgoing"
                    FontFamily="OutfitRegular"
                    FontSize="16"
                    TextColor="Gray"
                    IsVisible="{Binding HasOutgoingDeliveries}"/>

                <Grid IsVisible="{Binding HasOutgoingDeliveries}">
                    <VerticalStackLayout Spacing="10">
                        <!-- Swipeable Carousel -->
                        <CarouselView
                            x:Name="OutgoingCarousel"
                            ItemsSource="{Binding OutgoingDeliveries}"
                            HeightRequest="140"
                            PeekAreaInsets="40"
                            Loop="False"
                            CurrentItem="{Binding CurrentOutgoingDelivery}">
                            <CarouselView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="5">
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:HomeScreenModel}}, Path=CopyVerificationCodeCommand}"
                                                CommandParameter="{Binding .}"/>
                                        </Grid.GestureRecognizers>

                                        <RoundRectangle
                                            Fill="{Binding StatusColor}"
                                            CornerRadius="15"
                                            Stroke="#2D4A6E"
                                            StrokeThickness="2"/>

                                        <Grid Padding="15" RowDefinitions="Auto, *" RowSpacing="5">
                                            <Label
                                                Grid.Row="0"
                                                Text="{Binding ReceiverText}"
                                                FontFamily="OutfitBold"
                                                FontSize="18"
                                                FontAttributes="Bold"
                                                LineBreakMode="TailTruncation"/>

                                            <Grid Grid.Row="1" ColumnDefinitions="Auto, *" ColumnSpacing="10">
                                                <VerticalStackLayout Grid.Column="0" Spacing="3">
                                                    <Label
                                                        Text="{Binding VerificationText}"
                                                        FontFamily="OutfitRegular"
                                                        FontSize="14"/>
                                                    <Label
                                                        Text="{Binding DestinationText}"
                                                        FontFamily="OutfitLight"
                                                        FontSize="13"
                                                        TextColor="Gray"/>
                                                    <Label
                                                        Text="{Binding StatusText}"
                                                        FontFamily="OutfitRegular"
                                                        FontSize="13"
                                                        TextColor="#2D4A6E"/>
                                                </VerticalStackLayout>

                                                <Border 
                                                    Grid.Column="1"
                                                    BackgroundColor="#FFFFFF"
                                                    Stroke="#2D4A6E"
                                                    StrokeThickness="1"
                                                    Padding="8"
                                                    VerticalOptions="Fill"
                                                    IsVisible="{Binding HasMessage}">
                                                    <Border.StrokeShape>
                                                        <RoundRectangle CornerRadius="8"/>
                                                    </Border.StrokeShape>
                                                    <ScrollView>
                                                        <Label
                                                            Text="{Binding Message}"
                                                            FontFamily="OutfitLight"
                                                            FontSize="11"
                                                            TextColor="#2D4A6E"
                                                            LineBreakMode="WordWrap"/>
                                                    </ScrollView>
                                                </Border>
                                            </Grid>
                                        </Grid>
                                    </Grid>
                                </DataTemplate>
                            </CarouselView.ItemTemplate>
                        </CarouselView>

                        <!-- Indicator Dots -->
                        <IndicatorView
                            IndicatorColor="LightGray"
                            SelectedIndicatorColor="#2D4A6E"
                            HorizontalOptions="Center"
                            IndicatorsShape="Circle"
                            IndicatorSize="8"
                            ItemsSource="{Binding OutgoingDeliveries}"
                            Position="{Binding Source={x:Reference OutgoingCarousel}, Path=Position}"/>
                    </VerticalStackLayout>
                </Grid>

                <!-- Incoming Deliveries -->
                <Label
                    Text="Incoming"
                    FontFamily="OutfitRegular"
                    FontSize="16"
                    TextColor="Gray"
                    Margin="0, 10, 0, 0"
                    IsVisible="{Binding HasIncomingDeliveries}"/>

                <Grid IsVisible="{Binding HasIncomingDeliveries}">
                    <VerticalStackLayout Spacing="10">
                        <!-- Swipeable Carousel -->
                        <CarouselView
                            x:Name="IncomingCarousel"
                            ItemsSource="{Binding IncomingDeliveries}"
                            HeightRequest="140"
                            PeekAreaInsets="40"
                            Loop="False"
                            CurrentItem="{Binding CurrentIncomingDelivery}">
                            <CarouselView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="5">
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:HomeScreenModel}}, Path=CopyVerificationCodeCommand}"
                                                CommandParameter="{Binding .}"/>
                                        </Grid.GestureRecognizers>

                                        <RoundRectangle
                                            Fill="{Binding StatusColor}"
                                            CornerRadius="15"
                                            Stroke="#2D4A6E"
                                            StrokeThickness="2"/>

                                        <Grid Padding="15" RowDefinitions="Auto, *" RowSpacing="5">
                                            <Label
                                                Grid.Row="0"
                                                Text="{Binding SenderText}"
                                                FontFamily="OutfitBold"
                                                FontSize="18"
                                                FontAttributes="Bold"
                                                LineBreakMode="TailTruncation"/>

                                            <Grid Grid.Row="1" ColumnDefinitions="Auto, *" ColumnSpacing="10">
                                                <VerticalStackLayout Grid.Column="0" Spacing="3">
                                                    <Label
                                                        Text="{Binding VerificationText}"
                                                        FontFamily="OutfitRegular"
                                                        FontSize="14"/>
                                                    <Label
                                                        Text="{Binding DestinationText}"
                                                        FontFamily="OutfitLight"
                                                        FontSize="13"
                                                        TextColor="Gray"/>
                                                    <Label
                                                        Text="{Binding StatusText}"
                                                        FontFamily="OutfitRegular"
                                                        FontSize="13"
                                                        TextColor="#2D4A6E"/>
                                                </VerticalStackLayout>

                                                <Border 
                                                    Grid.Column="1"
                                                    BackgroundColor="#FFFFFF"
                                                    Stroke="#2D4A6E"
                                                    StrokeThickness="1"
                                                    Padding="8"
                                                    VerticalOptions="Fill"
                                                    IsVisible="{Binding HasMessage}">
                                                    <Border.StrokeShape>
                                                        <RoundRectangle CornerRadius="8"/>
                                                    </Border.StrokeShape>
                                                    <ScrollView>
                                                        <Label
                                                            Text="{Binding Message}"
                                                            FontFamily="OutfitLight"
                                                            FontSize="11"
                                                            TextColor="#2D4A6E"
                                                            LineBreakMode="WordWrap"/>
                                                    </ScrollView>
                                                </Border>
                                            </Grid>
                                        </Grid>
                                    </Grid>
                                </DataTemplate>
                            </CarouselView.ItemTemplate>
                        </CarouselView>

                        <!-- Indicator Dots -->
                        <IndicatorView
                            IndicatorColor="LightGray"
                            SelectedIndicatorColor="#2D4A6E"
                            HorizontalOptions="Center"
                            IndicatorsShape="Circle"
                            IndicatorSize="8"
                            ItemsSource="{Binding IncomingDeliveries}"
                            Position="{Binding Source={x:Reference IncomingCarousel}, Path=Position}"/>
                    </VerticalStackLayout>
                </Grid>

                <!-- Empty State -->
                <VerticalStackLayout 
                        IsVisible="{Binding HasNoDeliveries}"
                        Spacing="10"
                        VerticalOptions="Center"
                        Margin="0, 40, 0, 0">
                    <Label
                        Text="📦"
                        FontSize="60"
                        HorizontalOptions="Center"/>
                    <Label
                        Text="No active deliveries"
                        FontFamily="OutfitRegular"
                        FontSize="18"
                        TextColor="Gray"
                        HorizontalOptions="Center"/>
                    <Label
                        Text="Create a delivery to get started!"
                        FontFamily="OutfitLight"
                        FontSize="14"
                        TextColor="Gray"
                        HorizontalOptions="Center"/>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>