<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LalabotApplication.Screens.AvatarPickerScreen"
             Title="Choose Avatar"
             NavigationPage.HasNavigationBar="True">

    <Grid RowDefinitions="Auto,*,Auto" Margin="20">

        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Spacing="5" Margin="0,10,0,20">
            <Label
                Text="Choose Your Avatar"
                FontFamily="OutfitRegular"
                FontSize="26"
                FontAttributes="Bold"
                HorizontalOptions="Center"
                TextColor="#2D2D2D"/>
            <Label
                Text="Select an avatar or upload your own photo"
                FontFamily="OutfitLight"
                FontSize="14"
                HorizontalOptions="Center"
                TextColor="#A3A3A4"/>
        </VerticalStackLayout>

        <!-- Avatar Grid + Upload Button -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="20">
                
                <!-- Upload Photo Button with Preview -->
                <Grid>
                    <RoundRectangle
                        Fill="AliceBlue"
                        Stroke="{Binding CustomPhotoStrokeColor}"
                        StrokeThickness="{Binding CustomPhotoStrokeThickness}"
                        CornerRadius="15"/>
                    
                    <Grid Padding="15" ColumnDefinitions="Auto,*,Auto">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding UploadPhotoCommand}"/>
                        </Grid.GestureRecognizers>
                        
                        <!-- Camera Icon OR Preview Image -->
                        <Grid Grid.Column="0" 
                              HeightRequest="60" 
                              WidthRequest="60"
                              Margin="0,0,15,0">
                            
                            <!-- Default Camera Icon (when no custom photo) -->
                            <Grid IsVisible="{Binding HasNoCustomPhoto}">
                                <Ellipse Fill="#2D4A6E" 
                                         HeightRequest="60" 
                                         WidthRequest="60"/>
                                <Image HorizontalOptions="Center" VerticalOptions="Center">
                                    <Image.Source>
                                        <FontImageSource
                                            FontFamily="LineIcons"
                                            Glyph="&#xea2f;"
                                            Size="30"
                                            Color="White"/>
                                    </Image.Source>
                                </Image>
                            </Grid>
                            
                            <!-- Custom Photo Preview (when uploaded) -->
                            <Grid IsVisible="{Binding HasCustomPhoto}">
                                <Ellipse 
                                    Fill="White" 
                                    Stroke="#2D4A6E" 
                                    StrokeThickness="2" 
                                    HeightRequest="60" 
                                    WidthRequest="60"/>
                                <Image
                                    Source="{Binding SelectedAvatarUrl}"
                                    Aspect="AspectFill"
                                    HeightRequest="56"
                                    WidthRequest="56"
                                    HorizontalOptions="Center"
                                    VerticalOptions="Center">
                                    <Image.Clip>
                                        <EllipseGeometry Center="28,28" RadiusX="28" RadiusY="28"/>
                                    </Image.Clip>
                                </Image>
                            </Grid>
                        </Grid>
                        
                        <!-- Text -->
                        <VerticalStackLayout Grid.Column="1" 
                                             VerticalOptions="Center" 
                                             Spacing="2">
                            <Label 
                                Text="{Binding UploadButtonTitle}"
                                FontFamily="OutfitRegular"
                                FontSize="18"
                                FontAttributes="Bold"
                                TextColor="#2D4A6E"/>
                            <Label 
                                Text="{Binding UploadButtonSubtitle}"
                                FontFamily="OutfitLight"
                                FontSize="12"
                                TextColor="Gray"/>
                        </VerticalStackLayout>
                        
                        <!-- Check Icon (when custom photo selected) -->
                        <Grid Grid.Column="2" 
                              HeightRequest="30" 
                              WidthRequest="30" 
                              IsVisible="{Binding HasCustomPhoto}">
                            <Ellipse Fill="#2D4A6E" HeightRequest="30" WidthRequest="30"/>
                            <Image HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Source>
                                    <FontImageSource FontFamily="LineIcons" Glyph="&#xea4e;" Size="20" Color="White"/>
                                </Image.Source>
                            </Image>
                        </Grid>
                    </Grid>
                    
                    <!-- Loading Indicator -->
                    <ActivityIndicator 
                        IsRunning="{Binding IsUploading}"
                        IsVisible="{Binding IsUploading}"
                        Color="#2D4A6E"
                        HeightRequest="40"
                        WidthRequest="40"/>
                </Grid>

                <!-- Divider -->
                <Grid ColumnDefinitions="*,Auto,*" Margin="0,10">
                    <BoxView Grid.Column="0"
                             HeightRequest="1"
                             BackgroundColor="#E0E0E0"
                             VerticalOptions="Center"/>
                    <Label Grid.Column="1"
                           Text="OR CHOOSE A DEFAULT"
                           FontFamily="OutfitLight"
                           FontSize="12"
                           TextColor="Gray"
                           Margin="10,0"/>
                    <BoxView Grid.Column="2"
                             HeightRequest="1"
                             BackgroundColor="#E0E0E0"
                             VerticalOptions="Center"/>
                </Grid>

                <!-- Default Avatars Grid -->
                <Grid RowDefinitions="Auto,Auto" 
                      ColumnDefinitions="*,*,*" 
                      RowSpacing="15" 
                      ColumnSpacing="15" 
                      HorizontalOptions="Center">

                    <!-- Row 1 -->
                    <!-- Avatar 0 -->
                    <Grid Grid.Row="0" Grid.Column="0" HeightRequest="110" WidthRequest="110">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnAvatarTapped" />
                        </Grid.GestureRecognizers>
                        <RoundRectangle x:Name="Border0" Fill="AliceBlue" Stroke="#E0E0E0" StrokeThickness="2" CornerRadius="20"/>
                        <RoundRectangle x:Name="SelectedBorder0" Fill="Transparent" Stroke="#2D4A6E" StrokeThickness="4" CornerRadius="20" IsVisible="False"/>
                        <Grid Margin="10">
                            <Ellipse Fill="White" Stroke="#2D4A6E" StrokeThickness="2" HeightRequest="90" WidthRequest="90"/>
                            <Image Source="avatar_0.png" Aspect="AspectFill" HeightRequest="86" WidthRequest="86" HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Clip>
                                    <EllipseGeometry Center="43,43" RadiusX="43" RadiusY="43"/>
                                </Image.Clip>
                            </Image>
                        </Grid>
                        <Grid x:Name="Check0" HeightRequest="30" WidthRequest="30" HorizontalOptions="End" VerticalOptions="Start" Margin="5" IsVisible="False">
                            <Ellipse Fill="#2D4A6E" HeightRequest="30" WidthRequest="30"/>
                            <Image HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Source>
                                    <FontImageSource FontFamily="LineIcons" Glyph="&#xea4e;" Size="20" Color="White"/>
                                </Image.Source>
                            </Image>
                        </Grid>
                    </Grid>

                    <!-- Avatar 1 -->
                    <Grid Grid.Row="0" Grid.Column="1" HeightRequest="110" WidthRequest="110">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnAvatarTapped" />
                        </Grid.GestureRecognizers>
                        <RoundRectangle x:Name="Border1" Fill="AliceBlue" Stroke="#E0E0E0" StrokeThickness="2" CornerRadius="20"/>
                        <RoundRectangle x:Name="SelectedBorder1" Fill="Transparent" Stroke="#2D4A6E" StrokeThickness="4" CornerRadius="20" IsVisible="False"/>
                        <Grid Margin="10">
                            <Ellipse Fill="White" Stroke="#2D4A6E" StrokeThickness="2" HeightRequest="90" WidthRequest="90"/>
                            <Image Source="avatar_1.png" Aspect="AspectFill" HeightRequest="86" WidthRequest="86" HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Clip>
                                    <EllipseGeometry Center="43,43" RadiusX="43" RadiusY="43"/>
                                </Image.Clip>
                            </Image>
                        </Grid>
                        <Grid x:Name="Check1" HeightRequest="30" WidthRequest="30" HorizontalOptions="End" VerticalOptions="Start" Margin="5" IsVisible="False">
                            <Ellipse Fill="#2D4A6E" HeightRequest="30" WidthRequest="30"/>
                            <Image HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Source>
                                    <FontImageSource FontFamily="LineIcons" Glyph="&#xea4e;" Size="20" Color="White"/>
                                </Image.Source>
                            </Image>
                        </Grid>
                    </Grid>

                    <!-- Avatar 2 -->
                    <Grid Grid.Row="0" Grid.Column="2" HeightRequest="110" WidthRequest="110">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnAvatarTapped" />
                        </Grid.GestureRecognizers>
                        <RoundRectangle x:Name="Border2" Fill="AliceBlue" Stroke="#E0E0E0" StrokeThickness="2" CornerRadius="20"/>
                        <RoundRectangle x:Name="SelectedBorder2" Fill="Transparent" Stroke="#2D4A6E" StrokeThickness="4" CornerRadius="20" IsVisible="False"/>
                        <Grid Margin="10">
                            <Ellipse Fill="White" Stroke="#2D4A6E" StrokeThickness="2" HeightRequest="90" WidthRequest="90"/>
                            <Image Source="avatar_2.png" Aspect="AspectFill" HeightRequest="86" WidthRequest="86" HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Clip>
                                    <EllipseGeometry Center="43,43" RadiusX="43" RadiusY="43"/>
                                </Image.Clip>
                            </Image>
                        </Grid>
                        <Grid x:Name="Check2" HeightRequest="30" WidthRequest="30" HorizontalOptions="End" VerticalOptions="Start" Margin="5" IsVisible="False">
                            <Ellipse Fill="#2D4A6E" HeightRequest="30" WidthRequest="30"/>
                            <Image HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Source>
                                    <FontImageSource FontFamily="LineIcons" Glyph="&#xea4e;" Size="20" Color="White"/>
                                </Image.Source>
                            </Image>
                        </Grid>
                    </Grid>

                    <!-- Row 2 -->
                    <!-- Avatar 3 -->
                    <Grid Grid.Row="1" Grid.Column="0" HeightRequest="110" WidthRequest="110">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnAvatarTapped" />
                        </Grid.GestureRecognizers>
                        <RoundRectangle x:Name="Border3" Fill="AliceBlue" Stroke="#E0E0E0" StrokeThickness="2" CornerRadius="20"/>
                        <RoundRectangle x:Name="SelectedBorder3" Fill="Transparent" Stroke="#2D4A6E" StrokeThickness="4" CornerRadius="20" IsVisible="False"/>
                        <Grid Margin="10">
                            <Ellipse Fill="White" Stroke="#2D4A6E" StrokeThickness="2" HeightRequest="90" WidthRequest="90"/>
                            <Image Source="avatar_3.png" Aspect="AspectFill" HeightRequest="86" WidthRequest="86" HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Clip>
                                    <EllipseGeometry Center="43,43" RadiusX="43" RadiusY="43"/>
                                </Image.Clip>
                            </Image>
                        </Grid>
                        <Grid x:Name="Check3" HeightRequest="30" WidthRequest="30" HorizontalOptions="End" VerticalOptions="Start" Margin="5" IsVisible="False">
                            <Ellipse Fill="#2D4A6E" HeightRequest="30" WidthRequest="30"/>
                            <Image HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Source>
                                    <FontImageSource FontFamily="LineIcons" Glyph="&#xea4e;" Size="20" Color="White"/>
                                </Image.Source>
                            </Image>
                        </Grid>
                    </Grid>

                    <!-- Avatar 4 -->
                    <Grid Grid.Row="1" Grid.Column="1" HeightRequest="110" WidthRequest="110">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnAvatarTapped" />
                        </Grid.GestureRecognizers>
                        <RoundRectangle x:Name="Border4" Fill="AliceBlue" Stroke="#E0E0E0" StrokeThickness="2" CornerRadius="20"/>
                        <RoundRectangle x:Name="SelectedBorder4" Fill="Transparent" Stroke="#2D4A6E" StrokeThickness="4" CornerRadius="20" IsVisible="False"/>
                        <Grid Margin="10">
                            <Ellipse Fill="White" Stroke="#2D4A6E" StrokeThickness="2" HeightRequest="90" WidthRequest="90"/>
                            <Image Source="avatar_4.png" Aspect="AspectFill" HeightRequest="86" WidthRequest="86" HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Clip>
                                    <EllipseGeometry Center="43,43" RadiusX="43" RadiusY="43"/>
                                </Image.Clip>
                            </Image>
                        </Grid>
                        <Grid x:Name="Check4" HeightRequest="30" WidthRequest="30" HorizontalOptions="End" VerticalOptions="Start" Margin="5" IsVisible="False">
                            <Ellipse Fill="#2D4A6E" HeightRequest="30" WidthRequest="30"/>
                            <Image HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Source>
                                    <FontImageSource FontFamily="LineIcons" Glyph="&#xea4e;" Size="20" Color="White"/>
                                </Image.Source>
                            </Image>
                        </Grid>
                    </Grid>

                    <!-- Avatar 5 -->
                    <Grid Grid.Row="1" Grid.Column="2" HeightRequest="110" WidthRequest="110">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnAvatarTapped" />
                        </Grid.GestureRecognizers>
                        <RoundRectangle x:Name="Border5" Fill="AliceBlue" Stroke="#E0E0E0" StrokeThickness="2" CornerRadius="20"/>
                        <RoundRectangle x:Name="SelectedBorder5" Fill="Transparent" Stroke="#2D4A6E" StrokeThickness="4" CornerRadius="20" IsVisible="False"/>
                        <Grid Margin="10">
                            <Ellipse Fill="White" Stroke="#2D4A6E" StrokeThickness="2" HeightRequest="90" WidthRequest="90"/>
                            <Image Source="avatar_5.png" Aspect="AspectFill" HeightRequest="86" WidthRequest="86" HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Clip>
                                    <EllipseGeometry Center="43,43" RadiusX="43" RadiusY="43"/>
                                </Image.Clip>
                            </Image>
                        </Grid>
                        <Grid x:Name="Check5" HeightRequest="30" WidthRequest="30" HorizontalOptions="End" VerticalOptions="Start" Margin="5" IsVisible="False">
                            <Ellipse Fill="#2D4A6E" HeightRequest="30" WidthRequest="30"/>
                            <Image HorizontalOptions="Center" VerticalOptions="Center">
                                <Image.Source>
                                    <FontImageSource FontFamily="LineIcons" Glyph="&#xea4e;" Size="20" Color="White"/>
                                </Image.Source>
                            </Image>
                        </Grid>
                    </Grid>

                </Grid>
            </VerticalStackLayout>
        </ScrollView>

        <!--Buttons-->
        <VerticalStackLayout Grid.Row="2" Spacing="10" Margin="0,20,0,10">
            <Button
                Text="Select Avatar"
                BackgroundColor="#2D4A6E"
                TextColor="White"
                FontFamily="OutfitRegular"
                FontSize="18"
                HeightRequest="55"
                CornerRadius="15"
                Command="{Binding ConfirmSelectionCommand}"/>

            <Button
                Text="Cancel"
                BackgroundColor="Transparent"
                TextColor="#2D4A6E"
                FontFamily="OutfitLight"
                FontSize="16"
                BorderColor="#2D4A6E"
                BorderWidth="2"
                HeightRequest="50"
                CornerRadius="15"
                Command="{Binding CancelCommand}"/>
        </VerticalStackLayout>
    </Grid>
</ContentPage>